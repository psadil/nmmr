<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vtf • nmmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="vtf">
<meta property="og:description" content="nmmr">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-VX8V7SDMRL"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VX8V7SDMRL');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">nmmr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/deming-regression.html">Bayesian Hierarchical Deming Regression</a>
    </li>
    <li>
      <a href="../../articles/articles/orthogonal.html">Orthogonal Regression</a>
    </li>
    <li>
      <a href="../../articles/articles/vtf.html">vtf</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/psadil/nmmr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vtf_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>vtf</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/psadil/nmmr/blob/master/vignettes/articles/vtf.Rmd"><code>vignettes/articles/vtf.Rmd</code></a></small>
      <div class="hidden name"><code>vtf.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://psadil.github.io/nmmr/">nmmr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org">forcats</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></code></pre></div>
<p>Fitting a the main Bayesian model is comparable to the Bayesian model presented in <code>vignette('deming-regression')</code>. This vignette additionally walks through how <code>nmmr</code> can be used to compare two models.</p>
<div class="figure">
<img src="sd-model.png" alt='Schematic of the Bayesian model. Filled square nodes indicate priors, open circles are estimated parameters, the shaded circles are observed data, and the open diamond is the result of a deterministic function of the parameters. Nodes are grouped with the square "plates", indicating over which subsets of the data the node is replicated. The distribution assigned to each node is listed to the right of the diagram. $N(\mu,\sigma)$ is a normal with location $\mu$ and scale $\sigma$, and $TN(\mu,\sigma)$ is a normal with the same parameters, truncated below at $\mu$. Each equation in the upper right is associated with an arrow in the diagram, describing a relationship between nodes.' width="100%"><p class="caption">
Schematic of the Bayesian model. Filled square nodes indicate priors, open circles are estimated parameters, the shaded circles are observed data, and the open diamond is the result of a deterministic function of the parameters. Nodes are grouped with the square “plates”, indicating over which subsets of the data the node is replicated. The distribution assigned to each node is listed to the right of the diagram. <span class="math inline">\(N(\mu,\sigma)\)</span> is a normal with location <span class="math inline">\(\mu\)</span> and scale <span class="math inline">\(\sigma\)</span>, and <span class="math inline">\(TN(\mu,\sigma)\)</span> is a normal with the same parameters, truncated below at <span class="math inline">\(\mu\)</span>. Each equation in the upper right is associated with an arrow in the diagram, describing a relationship between nodes.
</p>
</div>
<div id="run-model" class="section level1">
<h1 class="hasAnchor">
<a href="#run-model" class="anchor"></a>Run Model</h1>
<p>These models require a long time to run. To speed things along for this vignette, the dataset is reduced to just a few voxels</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">small</span> <span class="op">&lt;-</span> <span class="va">sub02</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">orientation</span>, <span class="va">run</span>, <span class="va">ses</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>voxel <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_drop.html">fct_drop</a></span><span class="op">(</span><span class="va">voxel</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p>Next, initialize two versions of the model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_multiplicative</span> <span class="op">&lt;-</span> <span class="va"><a href="../../reference/Model.html">Model</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">small</span>, form <span class="op">=</span> <span class="st">"multiplicative"</span><span class="op">)</span>
<span class="va">model_additive</span> <span class="op">&lt;-</span> <span class="va"><a href="../../reference/Model.html">Model</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">small</span>, form <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># fewer samples run for the sake of a quicker vignette</span>
<span class="co"># In a real analysis, you would probably want at least 4 chains with </span>
<span class="co"># 1000 samples each</span>
<span class="va">fit_multiplicative</span> <span class="op">&lt;-</span> <span class="va">model_multiplicative</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>
  chains <span class="op">=</span> <span class="fl">2</span>, 
  parallel_chains <span class="op">=</span> <span class="fl">2</span>, 
  seed <span class="op">=</span> <span class="fl">1</span>,
  iter_sampling <span class="op">=</span> <span class="fl">100</span>,
  iter_warmup <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">#&gt; Running MCMC with 2 parallel chains...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Chain 1 Iteration:   1 / 600 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: model_0b95315de16573fafb0d90234c40444f_model_namespace::log_prob: v_kappa[sym1__] is -nan, but must be greater than or equal to 0 (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 59, column 2 to column 77)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 2 Iteration:   1 / 600 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[289] is -nan, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[289] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[1873] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 90, column 2 to column 47)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[1] is -nan, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 1 Iteration: 100 / 600 [ 16%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 100 / 600 [ 16%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 200 / 600 [ 33%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 200 / 600 [ 33%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 300 / 600 [ 50%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 300 / 600 [ 50%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 400 / 600 [ 66%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 400 / 600 [ 66%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 500 / 600 [ 83%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 501 / 600 [ 83%]  (Sampling) </span>
<span class="co">#&gt; Chain 2 Iteration: 500 / 600 [ 83%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 501 / 600 [ 83%]  (Sampling) </span>
<span class="co">#&gt; Chain 1 Iteration: 600 / 600 [100%]  (Sampling) </span>
<span class="co">#&gt; Chain 1 finished in 17.8 seconds.</span>
<span class="co">#&gt; Chain 2 Iteration: 600 / 600 [100%]  (Sampling) </span>
<span class="co">#&gt; Chain 2 finished in 18.8 seconds.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Both chains finished successfully.</span>
<span class="co">#&gt; Mean chain execution time: 18.3 seconds.</span>
<span class="co">#&gt; Total execution time: 18.9 seconds.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Warning: 3 of 200 (2.0%) transitions ended with a divergence.</span>
<span class="co">#&gt; This may indicate insufficient exploration of the posterior distribution.</span>
<span class="co">#&gt; Possible remedies include: </span>
<span class="co">#&gt;   * Increasing adapt_delta closer to 1 (default is 0.8) </span>
<span class="co">#&gt;   * Reparameterizing the model (e.g. using a non-centered parameterization)</span>
<span class="co">#&gt;   * Using informative or weakly informative prior distributions</span>

<span class="va">fit_additive</span> <span class="op">&lt;-</span> <span class="va">model_additive</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>
  chains <span class="op">=</span> <span class="fl">2</span>, 
  parallel_chains <span class="op">=</span> <span class="fl">2</span>, 
  seed <span class="op">=</span> <span class="fl">1</span>,
  iter_sampling <span class="op">=</span> <span class="fl">100</span>,
  iter_warmup <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="co">#&gt; Running MCMC with 2 parallel chains...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Chain 1 Iteration:   1 / 600 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: model_0b95315de16573fafb0d90234c40444f_model_namespace::log_prob: v_kappa[sym1__] is -nan, but must be greater than or equal to 0 (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 59, column 2 to column 77)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 1 Exception: normal_lpdf: Location parameter[433] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 1</span>
<span class="co">#&gt; Chain 2 Iteration:   1 / 600 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[1873] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[1873] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[1940] is inf, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 90, column 2 to column 47)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: model_0b95315de16573fafb0d90234c40444f_model_namespace::log_prob: v_kappa[sym1__] is -1.13687e-13, but must be greater than or equal to 0 (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 59, column 2 to column 77)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 1 Iteration: 100 / 600 [ 16%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 100 / 600 [ 16%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 200 / 600 [ 33%]  (Warmup)</span>
<span class="co">#&gt; Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span>
<span class="co">#&gt; Chain 2 Exception: normal_lpdf: Location parameter[2017] is -nan, but must be finite! (in '/tmp/Rtmp5Zg0ji/model-a13c2a4db8ec.stan', line 121, column 4 to column 37)</span>
<span class="co">#&gt; Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span>
<span class="co">#&gt; Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span>
<span class="co">#&gt; Chain 2</span>
<span class="co">#&gt; Chain 2 Iteration: 200 / 600 [ 33%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 300 / 600 [ 50%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 300 / 600 [ 50%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 400 / 600 [ 66%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 400 / 600 [ 66%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 500 / 600 [ 83%]  (Warmup) </span>
<span class="co">#&gt; Chain 1 Iteration: 501 / 600 [ 83%]  (Sampling) </span>
<span class="co">#&gt; Chain 1 Iteration: 600 / 600 [100%]  (Sampling) </span>
<span class="co">#&gt; Chain 1 finished in 14.3 seconds.</span>
<span class="co">#&gt; Chain 2 Iteration: 500 / 600 [ 83%]  (Warmup) </span>
<span class="co">#&gt; Chain 2 Iteration: 501 / 600 [ 83%]  (Sampling) </span>
<span class="co">#&gt; Chain 2 Iteration: 600 / 600 [100%]  (Sampling) </span>
<span class="co">#&gt; Chain 2 finished in 16.9 seconds.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Both chains finished successfully.</span>
<span class="co">#&gt; Mean chain execution time: 15.6 seconds.</span>
<span class="co">#&gt; Total execution time: 16.9 seconds.</span></code></pre></div>
<p>As with any Bayesian analysis, you should be wary about convergence issues. See <code>vignette('deming-regression')</code> for a discussion on how to check the output of the model.</p>
<p>Note that, in this reduced example where there are only 30 voxels, the models will likely have convergence issues<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<div id="compare-models" class="section level2">
<h2 class="hasAnchor">
<a href="#compare-models" class="anchor"></a>Compare Models</h2>
<p>Assuming that the posterior was estimated accurately, they may now be used for model comparison. In the original report, models were compared based on their predictive abilities, based on an efficient approximation to leave-one-out cross-validation. To implement this, <code>nmmr</code> takes advantage of functions provided by the <a href="https://mc-stan.org/loo/"><code>loo</code></a> package. The first step involves using a <a href="https://psadil.github.io/nmmr/reference/ModelMCMC.html#method-loo"><code>$loo()</code></a> method to calculate the expected log pointwise predictive density (ELPD).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">elpd_multiplicative</span> <span class="op">&lt;-</span> <span class="va">fit_multiplicative</span><span class="op">$</span><span class="fu">loo</span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">elpd_additive</span> <span class="op">&lt;-</span> <span class="va">fit_additive</span><span class="op">$</span><span class="fu">loo</span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>The ELPD is closely related to information criteria like the AIC, BIC, or WAIC, but the ELPD requires fewer assumptions and is has more diagnostics for checking when the value should be questioned. For further details, see <code><a href="https://mc-stan.org/loo/reference/loo-glossary.html">help("loo-glossary", package="loo")</a></code>.</p>
<p>The output of the <a href="https://psadil.github.io/nmmr/reference/ModelMCMC.html#method-loo"><code>$loo()</code></a> method is an object that has class <code>psis_loo</code> (see <code><a href="https://mc-stan.org/loo/reference/loo.html">?loo::loo</a></code>), and so the diagnostics provided by the <a href="https://mc-stan.org/loo/"><code>loo</code></a> package are available. At a minimum, the object should be printed, and the <code>k</code> values should be inspected. Values of <code>k</code> larger than 0.7 are suspect, and indicate that the model comparison score cannot be trusted.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">elpd_multiplicative</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computed from 200 by 4320 log-likelihood matrix</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          Estimate    SE</span>
<span class="co">#&gt; elpd_loo  -9327.4  56.2</span>
<span class="co">#&gt; p_loo        95.4   3.1</span>
<span class="co">#&gt; looic     18654.9 112.3</span>
<span class="co">#&gt; ------</span>
<span class="co">#&gt; Monte Carlo SE of elpd_loo is NA.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Pareto k diagnostic values:</span>
<span class="co">#&gt;                          Count Pct.    Min. n_eff</span>
<span class="co">#&gt; (-Inf, 0.5]   (good)     4303  99.6%   9         </span>
<span class="co">#&gt;  (0.5, 0.7]   (ok)         16   0.4%   65        </span>
<span class="co">#&gt;    (0.7, 1]   (bad)         1   0.0%   47        </span>
<span class="co">#&gt;    (1, Inf)   (very bad)    0   0.0%   &lt;NA&gt;      </span>
<span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></code></pre></div>
<p>In this case, there were only a few voxels, and so the diagnostics indicate trouble. With more data, the diagnostics will likely improve.</p>
<p>For a full list of the diagnostics, see <code><a href="https://mc-stan.org/loo/reference/pareto-k-diagnostic.html">help("pareto-k-diagnostic", package="loo")</a></code>.</p>
<p>If the diagnostics look okay, ten the model may be compared.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">elpd_multiplicative</span>, <span class="va">elpd_additive</span><span class="op">)</span>
<span class="co">#&gt;        elpd_diff se_diff</span>
<span class="co">#&gt; model1   0.0       0.0  </span>
<span class="co">#&gt; model2 -15.7       4.6</span></code></pre></div>
<p>Higher scores are better. The winning model will always have an <code>elpd_diff</code> (ELPD difference) of 0, and the other models will be compared to this winner. A second column gives the standard error of the difference (e.g., for determining whether any difference is “reliable”). For details, see <code><a href="https://mc-stan.org/loo/reference/loo_compare.html">?loo::loo_compare</a></code>.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>For an expanded discussion on why, see <a href="https://betanalpha.github.io/assets/case_studies/identifiability.html" class="uri">https://betanalpha.github.io/assets/case_studies/identifiability.html</a>, and <a href="https://betanalpha.github.io/assets/case_studies/hierarchical_modeling.html" class="uri">https://betanalpha.github.io/assets/case_studies/hierarchical_modeling.html</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Patrick Sadil.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
